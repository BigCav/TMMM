<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Torn Misc Market Monitor</title>
  <style>
    body {
      background: #101215;
      color: #dbeafe;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
    }
    .container { width: 100%; max-width: 960px; }
    .header {
      background: #181a20;
      padding: 1.2rem 2rem;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.2rem;
      box-shadow: 0 2px 16px #000c;
    }
    .header-title {
      font-size: 1.5rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      letter-spacing: .02em;
      color: #e3f0ff;
    }
    .countdown {
      font-size: 1.05rem;
      font-weight: 600;
      color: #4ebcff;
      margin-right: 0.6rem;
      background: none; border: none; box-shadow: none;
      width: auto; height: auto; display: block;
      border-radius: 0; padding: 0; user-select: none;
      letter-spacing: 0.04em;
    }
    .tabs {
      display: flex;
      gap: 1.2rem;
      margin-top: 0.6rem;
      border-bottom: 2px solid #22262b;
      font-size: 1rem;
      margin-left: 0.3rem;
      margin-bottom: 1.5rem;
    }
    .tab {
      padding: 0.6rem 0 0.3rem 0;
      cursor: pointer;
      font-weight: 600;
      color: #7896b5;
      transition: color .13s, border-color .16s;
      margin-bottom: -2px;
    }
    .tab.active {
      color: #fff;
      border-bottom: 3px solid #35a7ff;
    }
    .add-bar {
      margin-bottom: 1.1rem;
      background: #181a20;
      border-radius: 12px;
      padding: 0.7rem 1.1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 1px 8px #0003;
    }
    .add-select, .add-input, .add-btn {
      background: #23262c;
      color: #e3f5ff;
      border: 1px solid #28303a;
      border-radius: 7px;
      padding: 0.34rem 0.6rem;
      font-size: 1rem;
      margin-right: 0.2rem;
      outline: none;
      transition: border .14s;
    }
    .add-select:focus, .add-input:focus { border: 1.2px solid #35a7ff; }
    .add-btn {
      cursor: pointer;
      font-weight: 600;
      background: #273851;
      color: #42b3ff;
      border: 1.5px solid #299fff;
      box-shadow: 0 1px 4px #12223344;
      transition: background .13s;
    }
    .add-btn:active { background: #1b283a; }
    table {
      width: 100%; border-collapse: collapse;
      background: #16181f;
      border-radius: 14px;
      overflow: hidden;
      margin-top: 1rem;
      margin-bottom: 0;
      box-shadow: 0 1px 8px #0007;
    }
    th, td {
      text-align: left;
      padding: 1rem 1.1rem;
      border-bottom: 1px solid #20222a;
    }
    th {
      background: #21242b;
      font-size: 1.08rem;
      color: #9fd8ff;
    }
    tr:last-child td { border-bottom: none; }
    .price-link, .profile-link {
      color: #35a7ff;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.15s;
    }
    .price-link:hover, .profile-link:hover {
      color: #53b9ff;
      text-decoration: underline;
    }
    .skeleton-text {
      display: inline-block;
      height: 1rem;
      background: linear-gradient(90deg, #1d232a 25%, #253041 55%, #1d232a 85%);
      border-radius: 6px;
      width: 70%;
      animation: pulse 1.2s infinite ease-in-out;
      vertical-align: middle;
    }
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
    .editable-input {
      background: #23262c;
      border: 1px solid #28303a;
      border-radius: 5px;
      color: #e3f5ff;
      padding: 0.25rem 0.5rem;
      width: 80px;
      font-size: 1rem;
      text-align: right;
      margin-right: 0.25rem;
      transition: border-color 0.14s;
    }
    .editable-input:focus {
      outline: 2px solid #35a7ff;
      border-color: #53b9ff;
      background: #232f45;
    }
    .bin-btn {
      background: none;
      border: none;
      color: #ff6060;
      font-size: 1.2em;
      cursor: pointer;
      vertical-align: middle;
      margin-left: 0.2em;
      transition: color 0.18s;
    }
    .bin-btn:hover { color: #ff2626; }
    .about-container {
      background: #181a20;
      border-radius: 13px;
      padding: 2.2rem 2rem 1.5rem 2rem;
      margin-top: 1.7rem;
      width: 100%; box-sizing: border-box;
      box-shadow: 0 2px 20px #0002;
      line-height: 1.7; max-width: 100%; color: #cbeafe;
    }
    .about-container h2 { color: #35a7ff; font-size: 1.2rem; margin-top: 0; margin-bottom: 0.3rem; }
    .about-container p { margin: 0.8rem 0; }
    .empty-message {
      margin: 2rem 0 2.5rem 0;
      padding: 2.2rem 2rem;
      background: #181a20;
      color: #b6e7ff;
      border-radius: 13px;
      text-align: center;
      font-size: 1.22rem;
      box-shadow: 0 2px 18px #0003;
    }
    .empty-btn {
      display: inline-block;
      margin-top: 1rem;
      padding: 0.6rem 1.4rem;
      font-size: 1.08rem;
      background: #273851;
      color: #43b2ff;
      border-radius: 8px;
      border: 2px solid #299fff;
      cursor: pointer;
      font-weight: 600;
      transition: background .13s;
    }
    .empty-btn:hover { background: #1b283a; color: #b9eaff; }
    @media (max-width: 700px) {
      th, td { padding: 0.5rem; font-size: 0.96rem; }
      .header { padding: 0.5rem 1rem; }
      .container { padding: 0; }
      .about-container { padding: 1rem 0.6rem 1.2rem 0.6rem; }
      .add-bar { flex-direction: column; gap: 0.8rem;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-title">ðŸ§  Torn Misc Market Monitor</div>
      <div style="display:flex;align-items:center;">
        <div class="countdown" id="countdown"></div>
      </div>
    </div>
    <div class="tabs">
      <div class="tab active" onclick="switchTab('market')">Market Listings</div>
      <div class="tab" onclick="switchTab('prices')">Price Monitor</div>
      <div class="tab" onclick="switchTab('about')">About</div>
    </div>
    <div id="market" class="tab-content">
      <div id="market-empty" class="empty-message" style="display:none;">
        <div>No items being monitored yet.<br>
          <button class="empty-btn" onclick="goToCreate()">Create your first item monitor</button>
        </div>
      </div>
      <table id="market-table" style="display:none;">
        <thead>
          <tr>
            <th>Item</th>
            <th>Listings</th>
            <th>Link</th>
          </tr>
        </thead>
        <tbody id="market-body"></tbody>
      </table>
    </div>
    <div id="prices" class="tab-content" style="display:none;">
      <div class="add-bar" id="add-bar"></div>
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Price Threshold</th>
            <th>Min Stock</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="price-body"></tbody>
      </table>
    </div>
    <div id="about" class="tab-content" style="display:none;">
      <div class="about-container">
        <h2>About Torn Misc Market Monitor</h2>
        <p>
          <b>Torn Misc Market Monitor</b> is a modern real-time market scanning tool for <a href="https://www.torn.com" class="price-link" target="_blank">Torn</a>, designed to help you snipe bargains on high-value miscellaneous items, whether for profit or personal use.
        </p>
        <p>
          &bull; Powered by the official <b>Torn V2 API</b> (via Cloudflare Worker backend), the monitor checks market listings every 15 seconds, always displaying the latest results.<br>
          &bull; <b>Custom price and stock alerts</b> let you instantly spot the best deals, with your rules saved privately in your browser (localStorage).<br>
          &bull; Listings are refreshed with minimal animation for clarity and speed.
        </p>
        <p>
          This tool is free to use and open for feedback or feature requests.<br>
          <b>Questions or need help?</b> Contact the creator in-game:
          <a class="profile-link" href="https://www.torn.com/profiles.php?XID=3858298" target="_blank">View my Torn profile &rarr;</a>
        </p>
        <p style="opacity:0.8; margin-top:1.5rem;">
          Not affiliated with Torn. All item data &copy; Torn.com.
        </p>
      </div>
    </div>
  </div>
  <script>
    // --- Config/Allowed Items ---
    const WORKER_URL = 'https://tmmm.cavauk1.workers.dev/';
    const ALLOWED_ITEMS = [
      { id: 889, name: "Travel Mug" }, { id: 897, name: "Bottle Cap" }, { id: 1087, name: "Tampon" }, { id: 1092, name: "Lubricant" },
      { id: 280, name: "Elephant Statue" }, { id: 1216, name: "Clippers" }, { id: 54, name: "Diamond Ring" }, { id: 905, name: "Car Keys" },
      { id: 1220, name: "Massage Oil" }, { id: 1222, name: "Picture Frame" }, { id: 1208, name: "Beach Ball" }, { id: 1269, name: "Cough Syrup" },
      { id: 1286, name: "Stapler" }, { id: 879, name: "Sour Milk" }, { id: 894, name: "Cosmetics Case" }, { id: 41, name: "DVD Player" }, { id: 45, name: "Hard Drive" }, 
      { id: 1274, name: "Mouth Wash" }, { id: 417, name: "RS232 Cable" }, { id: 1085, name: "Lipstick" }, { id: 1288, name: "Notepad" }, { id: 1094, name: "Syringe" },
      { id: 890, name: "Headphones" }, { id: 1266, name: "Shampoo" }, { id: 1217, name: "Shaving Foam" },
    ].sort((a,b)=>a.name.localeCompare(b.name)); // Alphabetical!
    let ITEMS = [], marketRows = [];
    let lastMarketListings = {}; // key: item.id, value: html string to show
    let isFetching = false;

    // ---- SETTINGS ----
    function loadSettings() {
      const saved = localStorage.getItem("marketSettings");
      if (saved) try {
        const arr = JSON.parse(saved);
        return Array.isArray(arr) ? arr.filter(Boolean) : [];
      } catch { return []; }
      return [];
    }
    function saveSettings() {
      localStorage.setItem("marketSettings", JSON.stringify(ITEMS));
    }

    // ---- TAB SWITCH ----
    function switchTab(name) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
      if (name === 'market') {
        document.querySelector('.tab:nth-child(1)').classList.add('active');
        document.getElementById('market').style.display = 'block';
        renderTableRows(); // Only show latest data or last skeleton
      } else if (name === 'prices') {
        document.querySelector('.tab:nth-child(2)').classList.add('active');
        document.getElementById('prices').style.display = 'block';
        renderPriceMonitor();
      } else if (name === 'about') {
        document.querySelector('.tab:nth-child(3)').classList.add('active');
        document.getElementById('about').style.display = 'block';
      }
    }

    // ---- TABLES ----
    function renderTableRows(showSkeleton = false) {
      const body = document.getElementById("market-body");
      const emptyMsg = document.getElementById("market-empty");
      const table = document.getElementById("market-table");
      marketRows = [];
      if (!ITEMS.length) {
        emptyMsg.style.display = '';
        table.style.display = 'none';
        return;
      } else {
        emptyMsg.style.display = 'none';
        table.style.display = '';
      }
      body.innerHTML = ITEMS.map(item => `
        <tr>
          <td>${item.name}</td>
          <td class="listings-cell">${
            showSkeleton
              ? '<span class="skeleton-text"></span>'
              : (lastMarketListings[item.id] ?? '<span class="skeleton-text"></span>')
          }</td>
          <td><a href="https://www.torn.com/page.php?sid=ItemMarket#/market/view=search&itemID=${item.id}&itemName=${encodeURIComponent(item.name)}&itemType=Other" class="price-link" target="_blank">Open</a></td>
        </tr>
      `).join('');
      marketRows = Array.from(body.querySelectorAll('tr'));
    }

    // ---- DATA FETCH ----
    async function fetchData() {
      if (!ITEMS.length) return;
      isFetching = true;
      renderTableRows(true); // Show skeletons only during fetch!
      try {
        const res = await fetch(WORKER_URL);
        const { data } = await res.json();
        lastMarketListings = {};
        ITEMS.forEach((item, i) => {
          const itemData = data?.[item.id]?.itemmarket;
          let html = '<span style="color:#7ec3fc">No matches</span>';
          if (itemData && Array.isArray(itemData.listings)) {
            const filtered = itemData.listings.filter(
              l => l.price <= item.maxPrice && l.amount >= item.minAmount
            );
            if (filtered.length) {
              html = filtered.map((l) =>
                `ðŸ’° $${l.price.toLocaleString()} Ã— ${l.amount}x`
              ).join("<br>");
            }
          }
          lastMarketListings[item.id] = html;
        });
        renderTableRows(false); // Show real data
      } catch (e) {
        // On error, keep last shown, just update error cells
        ITEMS.forEach((item, i) => {
          lastMarketListings[item.id] = '<span style="color:#fc7979">Error</span>';
        });
        renderTableRows(false);
      } finally {
        isFetching = false;
      }
    }

    // ---- PRICE MONITOR ----
    function renderPriceMonitor() {
      renderAddBar();
      const tbody = document.getElementById("price-body");
      tbody.innerHTML = "";
      ITEMS.forEach((item, idx) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.name}</td>
          <td>
            <input type="number" min="1" class="editable-input" value="${item.maxPrice}" data-type="maxPrice" data-idx="${idx}" />
          </td>
          <td>
            <input type="number" min="1" class="editable-input" value="${item.minAmount}" data-type="minAmount" data-idx="${idx}" />
          </td>
          <td>
            <button class="bin-btn" title="Remove" onclick="removeItem(${item.id})">&#128465;</button>
          </td>
        `;
        tbody.appendChild(row);
      });
      tbody.querySelectorAll('.editable-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = +e.target.getAttribute('data-idx');
          const type = e.target.getAttribute('data-type');
          const val = +e.target.value;
          ITEMS[idx][type] = isNaN(val) || val < 1 ? 1 : val;
          saveSettings();
          renderTableRows(false); // Render with current data, don't trigger skeleton or fetch
        });
      });
    }
    function renderAddBar() {
      const bar = document.getElementById("add-bar");
      const untracked = ALLOWED_ITEMS.filter(
        i => !ITEMS.some(j => j.id === i.id)
      );
      bar.innerHTML = '';
      if (!untracked.length) return;
      const select = document.createElement('select');
      select.className = "add-select";
      select.innerHTML =
        `<option value="" disabled selected>Add new itemâ€¦</option>` +
        untracked.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
      const price = document.createElement('input');
      price.type = 'number'; price.className = 'add-input'; price.placeholder = 'Price';
      price.min = 1; price.style.width = '90px';
      const stock = document.createElement('input');
      stock.type = 'number'; stock.className = 'add-input'; stock.placeholder = 'Min Stock';
      stock.min = 1; stock.style.width = '90px';
      const btn = document.createElement('button');
      btn.className = 'add-btn'; btn.textContent = 'Add';
      btn.disabled = true;
      let chosen = null;
      select.addEventListener('change', e => {
        chosen = ALLOWED_ITEMS.find(x => x.id == select.value);
        btn.disabled = !(chosen && price.value && stock.value);
      });
      price.addEventListener('input', () => btn.disabled = !(chosen && price.value && stock.value));
      stock.addEventListener('input', () => btn.disabled = !(chosen && price.value && stock.value));
      btn.addEventListener('click', () => {
        if (chosen && price.value > 0 && stock.value > 0) {
          ITEMS.push({
            id: chosen.id,
            name: chosen.name,
            maxPrice: +price.value,
            minAmount: +stock.value
          });
          saveSettings();
          renderTableRows(false);
          renderPriceMonitor();
          fetchData();
        }
      });
      bar.appendChild(select);
      bar.appendChild(price);
      bar.appendChild(stock);
      bar.appendChild(btn);
    }
    window.removeItem = function(id) {
      ITEMS = ITEMS.filter(i => i.id !== id);
      saveSettings();
      renderTableRows(false);
      renderPriceMonitor();
      fetchData();
    };

    // ---- COUNTDOWN ----
    function updateCountdown() {
      const now = Date.now();
      const sec = 15 - (Math.floor(now / 1000) % 15);
      const countdown = document.getElementById("countdown");
      if (countdown) {
        countdown.textContent =
          `Refreshing in ${sec === 1 ? '1 second' : (sec === 15 ? '0 seconds' : sec + ' seconds')}`;
      }
    }

    // ---- AUTO-REFRESH ----
    function syncRefresh(callback, interval = 15000) {
      const now = Date.now();
      const nextBoundary = interval - (now % interval);
      setTimeout(() => {
        runRefreshCycle(callback, interval);
        setInterval(() => runRefreshCycle(callback, interval), interval);
      }, nextBoundary);
    }
    function runRefreshCycle(callback, interval) {
      callback();
    }
    function goToCreate() {
      switchTab('prices');
      setTimeout(() => {
        const add = document.querySelector('.add-select');
        if (add) add.focus();
      }, 80);
    }

    // ---- INIT ----
    ITEMS = loadSettings();
    renderTableRows(false);
    fetchData();
    setInterval(updateCountdown, 300);
    syncRefresh(() => fetchData(), 15000);
  </script>
</body>
</html>
